name: Trigger OpenWRT Update

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  trigger-makefile-update:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Makefile hash update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.EXTERNAL_REPO_TOKEN }}
          repository: OpenListTeam/OpenWrt-Packages
          event-type: update-hashes
          client-payload: |
            {
              "source_repository": "${{ github.repository }}",
              "release_tag": "${{ github.event.release.tag_name || 'manual-trigger' }}",
              "release_name": "${{ github.event.release.name || 'Manual Trigger' }}",
              "release_url": "${{ github.event.release.html_url || github.server_url }}/${{ github.repository }}",
              "triggered_by": "${{ github.actor }}",
              "trigger_reason": "${{ github.event_name }}"
            }

      - name: Log trigger information
        run: |
          echo "ğŸš€ Successfully triggered Makefile hash update"
          echo "ğŸ“¦ Target repository: OpenListTeam/OpenWrt-Packages"
          echo "ğŸ·ï¸ Release tag: ${{ github.event.release.tag_name || 'manual-trigger' }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“… Trigger time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"